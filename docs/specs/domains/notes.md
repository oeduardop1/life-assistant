# Notes

> Notas estruturadas para conteúdo longo (resumos, relatórios, decisões).

---

## 1. Overview

O módulo de Notas armazena conteúdo estruturado gerado pela IA ou pelo usuário:
- Resumos de consultas médicas
- Relatórios semanais/mensais
- Análises de decisão
- Reflexões importantes

> **ADR-012:** Notas são usadas para conteúdo longo. Fatos granulares ficam em `knowledge_items`.

---

## 2. Tipos de Nota

| Tipo | Origem | Exemplos |
|------|--------|----------|
| **Auto-generated** | IA | Resumo semanal, nota de consulta |
| **Manual** | Usuário | Notas pessoais, reflexões |

**Notas automáticas do produto:**
- **Nota de consulta** — Resumo preparado para consultas médicas
- **Nota de relatório** — Relatórios semanais/mensais salvos como nota

---

## 3. Comportamentos

- Conteúdo em Markdown
- Tags livres (`string[]`)
- Pin/archiving
- Soft delete (lixeira)
- Excerpt gerado automaticamente a partir do conteúdo

---

## 4. Data Model

```typescript
// packages/database/src/schema/notes.ts

export const notes = pgTable('notes', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),

  // Content
  title: varchar('title', { length: 500 }).notNull(),
  content: text('content').notNull().default(''),
  excerpt: varchar('excerpt', { length: 500 }),

  // Organization
  tags: jsonb('tags').notNull().default([]), // string[]

  // Status
  isPinned: boolean('is_pinned').notNull().default(false),
  isArchived: boolean('is_archived').notNull().default(false),
  autoGenerated: boolean('auto_generated').notNull().default(true),

  // Soft delete
  deletedAt: timestamp('deleted_at', { withTimezone: true }),

  // Timestamps
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
}, (table) => ({
  userIdIdx: index('notes_user_id_idx').on(table.userId),
  titleIdx: index('notes_title_idx').on(table.title),
}));
```

---

## 5. Search (Full-Text)

```sql
CREATE INDEX notes_content_search_idx ON notes 
USING gin(to_tsvector('portuguese', title || ' ' || content));

CREATE OR REPLACE FUNCTION search_notes(
  p_user_id uuid,
  p_query text,
  p_limit int DEFAULT 20
)
RETURNS SETOF notes AS $$
BEGIN
  RETURN QUERY
  SELECT *
  FROM notes
  WHERE user_id = p_user_id
    AND deleted_at IS NULL
    AND to_tsvector('portuguese', title || ' ' || content) @@ plainto_tsquery('portuguese', p_query)
  ORDER BY ts_rank(to_tsvector('portuguese', title || ' ' || content), plainto_tsquery('portuguese', p_query)) DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. Triggers

```sql
CREATE OR REPLACE FUNCTION generate_note_excerpt()
RETURNS TRIGGER AS $$
BEGIN
  NEW.excerpt = LEFT(
    regexp_replace(NEW.content, E'[\\n\\r]+', ' ', 'g'),
    200
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER generate_notes_excerpt
  BEFORE INSERT OR UPDATE OF content ON notes
  FOR EACH ROW EXECUTE FUNCTION generate_note_excerpt();
```

---

## 7. Export & LGPD

- Notas são incluídas no export completo do usuário
- Notas automáticas são exportadas como Markdown
- Vault items permanecem criptografados (ver `core/auth-security.md`)

---

## 8. RLS

Todas as queries em `notes` são protegidas por RLS:
- `user_id` obrigatório
- Policies garantem acesso apenas ao dono

---

## 9. Related Documents

- [memory.md](memory.md) — Conhecimento granular (facts/insights)
- [reports.md](reports.md) — Relatórios geram notas automáticas
- [health.md](health.md) — Notas de consulta médica
- [auth-security.md](../core/auth-security.md) — Export LGPD

---

## 10. Definition of Done

- [ ] CRUD de notas
- [ ] Excerpt automático
- [ ] Busca full-text funcionando
- [ ] Tags, pin e archive
- [ ] Soft delete (lixeira)
- [ ] Export de notas em Markdown

---

*Última atualização: 27 Janeiro 2026*
